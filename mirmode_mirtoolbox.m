% MAPLE Lab Module: May 2022-June 2022 
% Konrad Swierczek
% MIRtoolbox

% Change this for analysis of different database
unzip('stimuli.zip')
directory = 'stimuli/wtc1_audio';
cd(directory);
% Import Files
fileinfo = dir('*.wav');

for fileindex = 1:length(fileinfo)
    factors_buf(1:3) = split(erase(fileinfo(fileindex).name,["Bach_WTC1_", ...
                                                             "_Prelude", ...
                                                             " (" + wildcardPattern + ")", ...
                                                             ".wav"]), "_");
    factors_buf(4) = extractBetween(fileinfo(fileindex).name,"(",")");
    factors(fileindex,:) = reshape(factors_buf, [1,4]);
end

% Mode Analysis
data = {'filename', 'artist', 'performance', 'chroma', 'mode', ... 
        'mode_val', 'mode_valsum', 'chromagram', 'krumhansl'};
for fileindex = 1:length(fileinfo)
    data(fileindex+1,:) = {fileinfo(fileindex).name, ...
                           factors(fileindex,1), ...
                           factors(fileindex,4), ...
                           factors(fileindex,2), ...
                           factors(fileindex,3), ...
                           mirgetdata(mirmode(fileinfo(fileindex).name)), ...
                           mirgetdata(mirmode(fileinfo(fileindex).name,'sum')), ...
                           mirgetdata(mirchromagram(fileinfo(fileindex).name)), ...
                           mirgetdata(mirkeystrength(fileinfo(fileindex).name))
                           };
end

dataTable = cell2table(data(2:end,:),'variablenames',data(1,:));
writetable(dataTable,'..\..\data\MIRtoolbox_mirmode.csv','Delimiter',',');

% Attack Rate
data2 = {'name', 'artist', 'performance', 'chroma', 'mode', ... 
         'onsets', 'length', 'onsetrate'};
for fileindex = 1:length(fileinfo)
    data2(fileindex+1,:) = {fileinfo(fileindex).name, ...
                            factors(fileindex, 1), ...
                            factors(fileindex, 4), ...
                            factors(fileindex, 2), ...
                            factors(fileindex, 3), ...
                            length(mirgetdata(mirevents(fileinfo(fileindex).name))) ...
                            mirgetdata(mirlength(fileinfo(fileindex).name)) ...
                            length(mirgetdata(mirevents(fileinfo(fileindex).name)))/mirgetdata(mirlength(fileinfo(fileindex).name))
                           };
end

dataTable2 = cell2table(data2(2:end,:),'variablenames',data2(1,:));
writetable(dataTable2,'..\..\data\MIRtoolbox_onsets.csv','Delimiter',',');

% Cleanup
cd ..\..
rmdir 'stimuli' s


% TODO: mirsegment, mirfilterbank, mirframe, mirspectrum, mirkeystrength
% All factors toward mirmode. Tweak as appropriate.